name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸš€ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ðŸ”„ Starting deployment..."
          
          # Verificar si el proyecto existe, si no, clonarlo
          if [ ! -d "/var/www/expoturs" ]; then
            echo "ðŸ“¦ Cloning repository..."
            cd /var/www
            git clone https://github.com/diegmero/expoturs.git
            cd expoturs
            
            echo "âš™ï¸ Setting up .env file..."
            cp .env.example .env
            sed -i 's/APP_NAME=.*/APP_NAME=Expotur/' .env
            sed -i 's/APP_ENV=.*/APP_ENV=production/' .env
            sed -i 's/APP_DEBUG=.*/APP_DEBUG=false/' .env
            sed -i 's/APP_URL=.*/APP_URL=http:\/\/20.168.113.88/' .env
            sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=sqlite/' .env
            sed -i '/DB_HOST=/d' .env
            sed -i '/DB_PORT=/d' .env
            sed -i '/DB_DATABASE=/d' .env
            sed -i '/DB_USERNAME=/d' .env
            sed -i '/DB_PASSWORD=/d' .env
            
            echo "ðŸ”‘ Generating application key..."
            php artisan key:generate
            
            echo "ðŸ—„ï¸ Creating SQLite database..."
            touch database/database.sqlite
            
            echo "ðŸ“¦ Installing Composer dependencies..."
            composer install --optimize-autoloader --no-dev
            
            echo "ðŸ“¦ Installing NPM dependencies..."
            npm install
            
            echo "ðŸ—ï¸ Building assets..."
            npm run build
            
            echo "ðŸ—„ï¸ Running migrations and seeders..."
            php artisan migrate:fresh --seed --force
            
            echo "ðŸ” Setting permissions..."
            chown -R www-data:www-data /var/www/expoturs
            chmod -R 755 /var/www/expoturs
            chmod -R 775 /var/www/expoturs/storage
            chmod -R 775 /var/www/expoturs/bootstrap/cache
            chmod 664 /var/www/expoturs/database/database.sqlite
            
            echo "âš™ï¸ Configuring Nginx..."
            cat > /etc/nginx/sites-available/expoturs << 'EOF'
          server {
              listen 80;
              server_name 20.168.113.88;
              root /var/www/expoturs/public;

              add_header X-Frame-Options "SAMEORIGIN";
              add_header X-Content-Type-Options "nosniff";

              index index.php;
              charset utf-8;

              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }

              location = /favicon.ico { access_log off; log_not_found off; }
              location = /robots.txt  { access_log off; log_not_found off; }

              error_page 404 /index.php;

              location ~ \.php$ {
                  fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
                  include fastcgi_params;
              }

              location ~ /\.(?!well-known).* {
                  deny all;
              }
          }
          EOF
            
            ln -sf /etc/nginx/sites-available/expoturs /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default
            nginx -t && systemctl reload nginx
            
            echo "âœ… Initial setup completed!"
          else
            echo "ðŸ“¥ Pulling latest changes..."
            cd /var/www/expoturs
            git pull origin main
            
            echo "ðŸ“¦ Installing Composer dependencies..."
            composer install --optimize-autoloader --no-dev
            
            echo "ðŸ“¦ Installing NPM dependencies..."
            npm install
            
            echo "ðŸ—ï¸ Building assets..."
            npm run build
            
            echo "ðŸ—„ï¸ Running migrations..."
            php artisan migrate --force
            
            echo "ðŸ§¹ Clearing and caching..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "ðŸ” Setting permissions..."
            chown -R www-data:www-data /var/www/expoturs
            chmod -R 755 /var/www/expoturs
            chmod -R 775 /var/www/expoturs/storage
            chmod -R 775 /var/www/expoturs/bootstrap/cache
            chmod 664 /var/www/expoturs/database/database.sqlite
            
            echo "âœ… Update completed!"
          fi
          
          echo "ðŸ”„ Restarting services..."
          systemctl restart php8.2-fpm
          systemctl restart nginx
          
          echo "âœ… Deployment completed successfully!"
